<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Service - Onyx Gas</title>
    
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- PayPal JS -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=GBP"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .header p { color: #ff6b35; font-size: 1.2rem; }
        .content { padding: 40px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .progress-step { flex: 1; text-align: center; position: relative; padding-top: 50px; font-size: 14px; color: #999; }
        .progress-step::before { content: ''; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #ddd; border-radius: 50%; z-index: 1; }
        .progress-step.active::before { background: #667eea; }
        .progress-step.completed::before { background: #28a745; content: '‚úì'; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .progress-step.active { color: #667eea; font-weight: bold; }
        h2 { color: #1a1a1a; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d2d2d; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 100px; }
        .price-box { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem; }
        .price-row.total { font-size: 1.3rem; font-weight: bold; color: #667eea; padding-top: 10px; border-top: 2px solid #ddd; }
        .payment-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .payment-method { border: 3px solid #ddd; padding: 30px; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .payment-method:hover { border-color: #667eea; transform: translateY(-3px); }
        .payment-method.selected { border-color: #667eea; background: #f0f4ff; }
        .payment-method h3 { margin-top: 10px; color: #1a1a1a; }
        #card-element { padding: 15px; border: 2px solid #ddd; border-radius: 5px; background: white; margin-top: 10px; }
        #paypal-button-container { margin-top: 20px; }
        .btn { background: #667eea; color: white; padding: 15px 40px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold; width: 100%; transition: background 0.3s; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; margin-top: 15px; }
        .btn-secondary:hover { background: #5a6268; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 40px; }
        .loading::after { content: ''; display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .payment-methods { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Book Your Service</h1>
            <p>Secure Payment | Gas Safe Registered | 07710 244557</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-step active">Service Details</div>
                <div class="progress-step">Payment</div>
                <div class="progress-step">Confirmation</div>
            </div>

            <!-- STEP 1: Service Details -->
            <div class="step active" id="step1">
                <h2>Service & Contact Information</h2>
                
                <form id="bookingForm">
                    <div class="form-group">
                        <label>Service Required *</label>
                        <select id="serviceType" required>
                            <option value="">Select a service</option>
                            <option value="Gas Meter Installation" data-price="450">Gas Meter Installation (from ¬£450)</option>
                            <option value="Boiler Servicing" data-price="85">Boiler Servicing (¬£85)</option>
                            <option value="Gas Pipework" data-price="350">Gas Pipework Installation (from ¬£350)</option>
                            <option value="Flue Termination" data-price="200">Flue Termination (from ¬£200)</option>
                            <option value="Safety Inspection" data-price="75">Safety Inspection (¬£75)</option>
                            <option value="Emergency Plumbing" data-price="120">Emergency Plumbing (from ¬£120)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="customerName" required>
                    </div>

                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="customerEmail" required>
                    </div>

                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="customerPhone" value="07710" required>
                    </div>

                    <div class="form-group">
                        <label>Service Address *</label>
                        <textarea id="address" required placeholder="Enter full address including postcode"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Preferred Date</label>
                        <input type="date" id="bookingDate" min="">
                    </div>

                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="notes" placeholder="Any specific requirements..."></textarea>
                    </div>

                    <div class="price-box">
                        <div class="price-row">
                            <span>Estimated Job Cost:</span>
                            <span id="totalAmount">¬£0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Deposit Required (20%):</span>
                            <span id="depositAmount">¬£0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Pay Today:</span>
                            <span id="payToday">¬£0.00</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Payment Policy:</strong> A 20% deposit is required to secure your booking. The remaining balance is payable upon completion.
                    </div>

                    <button type="button" class="btn" onclick="goToPayment()">Continue to Payment</button>
                    <a href="index.html" style="display:block;text-align:center;margin-top:15px;color:#667eea;text-decoration:none;">‚Üê Back to Home</a>
                </form>
            </div>

            <!-- STEP 2: Payment -->
            <div class="step" id="step2">
                <h2>Choose Payment Method</h2>

                <div class="alert alert-info" id="paymentSummary"></div>

                <div class="payment-methods">
                    <div class="payment-method" id="stripeMethod" onclick="selectPaymentMethod('stripe')">
                        <svg width="80" height="35" viewBox="0 0 60 25" xmlns="http://www.w3.org/2000/svg">
                            <rect width="60" height="25" rx="4" fill="#635BFF"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-weight="bold">STRIPE</text>
                        </svg>
                        <h3>Credit/Debit Card</h3>
                    </div>

                    <div class="payment-method" id="paypalMethod" onclick="selectPaymentMethod('paypal')">
                        <svg width="100" height="30" viewBox="0 0 100 32" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 8c-1-1.3-3.2-2-6.2-2H7.5c-.5 0-.9.3-1 .8L4 25c0 .3.2.6.5.6h3.7l.9-6c.1-.5.5-.8 1-.8h2c3.8 0 6.8-1.5 7.7-5.9.7-3.4-1-5.2-1.8-4.9z" fill="#003087"/>
                            <path d="M85 8c-1-1.3-3.2-2-6.2-2h-6.3c-.5 0-.9.3-1 .8L69 25c0 .3.2.6.5.6h3.7l.9-6c.1-.5.5-.8 1-.8h2c3.8 0 6.8-1.5 7.7-5.9.7-3.4-1-5.2-1.8-4.9z" fill="#0070E0"/>
                        </svg>
                        <h3>PayPal</h3>
                    </div>
                </div>

                <!-- Stripe Form -->
                <div id="stripePayment" style="display:none;">
                    <div class="form-group">
                        <label>Card Details</label>
                        <div id="card-element"></div>
                        <div id="card-errors" style="color:#721c24;margin-top:10px;"></div>
                    </div>
                    <button type="button" class="btn" id="stripeSubmit" onclick="processStripePayment()">
                        Pay ¬£<span id="stripeAmount">0.00</span>
                    </button>
                </div>

                <!-- PayPal -->
                <div id="paypalPayment" style="display:none;">
                    <div id="paypal-button-container"></div>
                </div>

                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
            </div>

            <!-- STEP 3: Confirmation -->
            <div class="step" id="step3">
                <div style="text-align:center;padding:40px;">
                    <div style="font-size:5rem;margin-bottom:20px;">‚úÖ</div>
                    <h2 style="color:#28a745;margin-bottom:20px;">Payment Successful!</h2>
                    <div class="alert alert-success" id="confirmationMessage"></div>
                    
                    <div style="background:#f8f9fa;padding:30px;border-radius:10px;margin:30px 0;text-align:left;">
                        <h3 style="margin-bottom:20px;">Booking Summary</h3>
                        <div id="bookingSummary"></div>
                    </div>

                    <p style="margin-bottom:30px;">Confirmation email sent to: <strong id="confirmEmail"></strong></p>
                    
                    <a href="index.html" class="btn">‚Üê Return to Homepage</a>
                </div>
            </div>

            <div id="loadingOverlay" style="display:none;" class="loading">Processing payment...</div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        const STRIPE_PUBLIC_KEY = 'pk_test_YOUR_STRIPE_PUBLISHABLE_KEY'; // UPDATE THIS
        
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        const elements = stripe.elements();
        const cardElement = elements.create('card', {
            style: {
                base: { fontSize: '16px', color: '#32325d', fontFamily: 'Arial, sans-serif' }
            }
        });

        let selectedPaymentMethod = null;
        let bookingData = {};

        document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];

        document.getElementById('serviceType').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const deposit = price * 0.2;
            document.getElementById('totalAmount').textContent = `¬£${price.toFixed(2)}`;
            document.getElementById('depositAmount').textContent = `¬£${deposit.toFixed(2)}`;
            document.getElementById('payToday').textContent = `¬£${deposit.toFixed(2)}`;
        });

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            document.querySelectorAll('.progress-step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i < step - 1) s.classList.add('completed');
                if (i === step - 1) s.classList.add('active');
            });
        }

        function goToPayment() {
            const form = document.getElementById('bookingForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const serviceSelect = document.getElementById('serviceType');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            
            bookingData = {
                customerName: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerPhone: document.getElementById('customerPhone').value,
                serviceType: serviceSelect.value,
                address: document.getElementById('address').value,
                bookingDate: document.getElementById('bookingDate').value || null,
                notes: document.getElementById('notes').value,
                amount: parseFloat(selectedOption.dataset.price),
                depositAmount: parseFloat(selectedOption.dataset.price) * 0.2
            };

            document.getElementById('paymentSummary').innerHTML = `
                <strong>Booking for:</strong> ${bookingData.customerName}<br>
                <strong>Service:</strong> ${bookingData.serviceType}<br>
                <strong>Deposit to pay:</strong> ¬£${bookingData.depositAmount.toFixed(2)}
            `;
            document.getElementById('stripeAmount').textContent = bookingData.depositAmount.toFixed(2);
            goToStep(2);
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            document.getElementById(`${method}Method`).classList.add('selected');
            document.getElementById('stripePayment').style.display = method === 'stripe' ? 'block' : 'none';
            document.getElementById('paypalPayment').style.display = method === 'paypal' ? 'block' : 'none';

            if (method === 'stripe' && !cardElement._parent) {
                cardElement.mount('#card-element');
            }
            if (method === 'paypal') {
                initializePayPal();
            }
        }

        async function processStripePayment() {
            const submitButton = document.getElementById('stripeSubmit');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            try {
                const response = await fetch(`${API_URL}/stripe-create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);

                const result = await stripe.confirmCardPayment(data.clientSecret, {
                    payment_method: { card: cardElement, billing_details: { name: bookingData.customerName } }
                });

                if (result.error) {
                    document.getElementById('card-errors').textContent = result.error.message;
                    submitButton.disabled = false;
                    submitButton.innerHTML = `Pay ¬£${bookingData.depositAmount.toFixed(2)}`;
                } else {
                    await fetch(`${API_URL}/stripe-confirm`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentIntentId: result.paymentIntent.id })
                    });
                    showConfirmation(result.paymentIntent.id);
                }
            } catch (error) {
                alert('Payment failed: ' + error.message);
                submitButton.disabled = false;
                submitButton.innerHTML = `Pay ¬£${bookingData.depositAmount.toFixed(2)}`;
            }
        }

        function initializePayPal() {
            document.getElementById('paypal-button-container').innerHTML = '';
            paypal.Buttons({
                createOrder: async function() {
                    const response = await fetch(`${API_URL}/paypal-create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingData)
                    });
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);
                    return data.orderId;
                },
                onApprove: async function(data) {
                    document.getElementById('loadingOverlay').style.display = 'block';
                    const response = await fetch(`${API_URL}/paypal-capture`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId: data.orderID })
                    });
                    const result = await response.json();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    if (result.success) {
                        showConfirmation(result.payment.transactionId);
                    } else {
                        alert('Payment failed: ' + result.message);
                    }
                },
                onError: function(err) {
                    alert('PayPal error. Please try again.');
                }
            }).render('#paypal-button-container');
        }

        function showConfirmation(transactionId) {
            document.getElementById('confirmationMessage').innerHTML = `
                Deposit of ¬£${bookingData.depositAmount.toFixed(2)} processed successfully.<br>
                <strong>Transaction ID:</strong> ${transactionId}
            `;
            document.getElementById('confirmEmail').textContent = bookingData.customerEmail;
            document.getElementById('bookingSummary').innerHTML = `
                <p><strong>Service:</strong> ${bookingData.serviceType}</p>
                <p><strong>Address:</strong> ${bookingData.address}</p>
                <p><strong>Date:</strong> ${bookingData.bookingDate ? new Date(bookingData.bookingDate).toLocaleDateString('en-GB') : 'To be confirmed'}</p>
                <p><strong>Deposit Paid:</strong> ¬£${bookingData.depositAmount.toFixed(2)}</p>
                <p><strong>Total Cost:</strong> ¬£${bookingData.amount.toFixed(2)}</p>
                <p><strong>Balance Due:</strong> ¬£${(bookingData.amount - bookingData.depositAmount).toFixed(2)}</p>
                <p><strong>Payment Method:</strong> ${selectedPaymentMethod === 'stripe' ? 'Card' : 'PayPal'}</p>
            `;
            goToStep(3);
        }

        cardElement.on('change', function(event) {
            document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
        });
    </script>
</body>
</html>
